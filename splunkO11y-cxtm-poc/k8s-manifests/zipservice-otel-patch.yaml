# Patch to add OpenTelemetry instrumentation to CXTM ZipService
spec:
  template:
    spec:
      initContainers:
      - name: otel-auto-instrumentation-install
        image: python:3.8-slim
        command: ['/bin/bash']
        args: ['/scripts/install-otel.sh']
        volumeMounts:
        - name: otel-auto-instrumentation
          mountPath: /otel-auto-instrumentation
        - name: otel-scripts
          mountPath: /scripts
        - name: pip-cache
          mountPath: /root/.cache/pip
        env:
        - name: PIP_CACHE_DIR
          value: /root/.cache/pip
      containers:
      - name: cxtm-zip-controller
        env:
        - name: OTEL_SERVICE_NAME
          value: "cxtm-zip-controller"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT  
          value: "http://otel-collector:4318"
        - name: OTEL_EXPORTER_OTLP_PROTOCOL
          value: "http/protobuf"
        - name: OTEL_TRACES_EXPORTER
          value: "otlp"
        - name: OTEL_METRICS_EXPORTER
          value: "otlp"
        - name: OTEL_PROPAGATORS
          value: "tracecontext,baggage"
        - name: OTEL_RESOURCE_ATTRIBUTES
          value: "deployment.environment=development,k8s.cluster.name=cxtm-dev,k8s.namespace.name=default,service.instance.id=zip-controller"
        - name: PYTHONPATH
          value: "/otel-auto-instrumentation:$PYTHONPATH"
        - name: OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED
          value: "true"
        volumeMounts:
        - name: otel-auto-instrumentation
          mountPath: /otel-auto-instrumentation
        - name: otel-scripts
          mountPath: /scripts
      - name: cxtm-zip-worker
        env:
        - name: OTEL_SERVICE_NAME
          value: "cxtm-zip-worker"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: "http://otel-collector:4318"
        - name: OTEL_EXPORTER_OTLP_PROTOCOL
          value: "http/protobuf"
        - name: OTEL_TRACES_EXPORTER
          value: "otlp"
        - name: OTEL_METRICS_EXPORTER
          value: "otlp"
        - name: OTEL_PROPAGATORS
          value: "tracecontext,baggage"
        - name: OTEL_RESOURCE_ATTRIBUTES
          value: "deployment.environment=development,k8s.cluster.name=cxtm-dev,k8s.namespace.name=default,service.instance.id=zip-worker"
        - name: PYTHONPATH
          value: "/otel-auto-instrumentation:$PYTHONPATH"
        - name: OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED
          value: "true"
        volumeMounts:
        - name: otel-auto-instrumentation
          mountPath: /otel-auto-instrumentation
        - name: otel-scripts
          mountPath: /scripts
      volumes:
      - name: otel-auto-instrumentation
        emptyDir: {}
      - name: otel-scripts
        configMap:
          name: otel-python-config
          defaultMode: 0755
      - name: pip-cache
        emptyDir: {}
